<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Global Missions | Cherry Hills Church</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- 1. Cesium CSS -->
    <link href="https://cdn.jsdelivr.net/npm/cesium@1.119/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        #cesiumContainer {
            width: 100%;
            height: 100%;
        }

        #homeButton {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            padding: 8px 12px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #homeButton:hover {
            background: rgba(255, 255, 255, 0.8);
            color: black;
        }
        #fullscreenButton {
            position: absolute;
            top: 10px;
            left: 80px;
            z-index: 1;
            padding: 8px 12px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #fullscreenButton:hover {
            background: rgba(255, 255, 255, 0.8);
            color: black;
        }
    </style>
</head>

<body>

    <!-- 2. Replace your old map div -->
    <button id="homeButton">Home</button>
    <button id="fullscreenButton">Fullscreen</button>
    <div id="cesiumContainer"></div>

    <!-- 3. Cesium JS -->
    <script src="https://cdn.jsdelivr.net/npm/cesium@1.119/Build/Cesium/Cesium.js"></script>
    <script>
        // 4. Provide your Cesium Ion access token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI1OWNhMDFjNi0wZTQ5LTRhMTQtYjVlOC0xZDExMDNjNTlmNjMiLCJpZCI6MzIwMTI0LCJpYXQiOjE3NTIxMTA1OTV9._asU_UV5t-_Z4Wx_VWoLS0-fg5T-GqrrrAzgTh75W-o';

        // 5. Initialize the globe viewer
        const viewer = new Cesium.Viewer('cesiumContainer', {
            imageryProvider: new Cesium.IonImageryProvider({ assetId: 2 }), // satellite imagery
            terrainProvider: new Cesium.EllipsoidTerrainProvider(),        // flat globe terrain
            animation: false,
            timeline: false,
            baseLayerPicker: true,
            geocoder: false,
            homeButton: false,
            sceneModePicker: true,
            navigationHelpButton: false,
            infoBox: false,
            scene3DOnly: true
        });

        // 5b. Enable real-time day/night lighting on the globe
        viewer.scene.globe.enableLighting = true;
        viewer.scene.globe.dynamicAtmosphereLightingFromSun = true;
        // Ensure the clock animates so lighting updates over time
        viewer.clock.shouldAnimate = true;
        // Optionally, smooth the transition between lit and unlit areas
        viewer.scene.globe.lightingFadeOutDistance = 1000000;
        viewer.scene.globe.lightingFadeInDistance = 3000000;

        // 5a. Set an initial camera view to control zoom level
        const initialView = {
            destination: Cesium.Cartesian3.fromDegrees(-98.5795, 39.8283, 16500000)
        };
        viewer.camera.setView(initialView);

        // Home button to reset view
        document.getElementById('homeButton').addEventListener('click', () => {
            viewer.camera.setView(initialView);
        });

        // Fullscreen toggle button
        const fsButton = document.getElementById('fullscreenButton');
        fsButton.addEventListener('click', () => {
          const elem = document.documentElement;
          if (!document.fullscreenElement) {
            if (elem.requestFullscreen) {
              elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
              elem.webkitRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
              elem.mozRequestFullScreen();
            } else if (elem.msRequestFullscreen) {
              elem.msRequestFullscreen();
            }
          } else {
            if (document.exitFullscreen) {
              document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
              document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
              document.mozCancelFullScreen();
            } else if (document.msExitFullscreen) {
              document.msExitFullscreen();
            }
          }
        });

        // Attempt to enter fullscreen on page load
        document.addEventListener('DOMContentLoaded', () => {
          const elem = document.documentElement;
          if (elem.requestFullscreen) {
            elem.requestFullscreen().catch(err => {
              console.warn('Fullscreen request failed:', err);
            });
          } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
          } else if (elem.mozRequestFullScreen) {
            elem.mozRequestFullScreen();
          } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
          }
        });

        // Threshold altitude (in meters) above which Springfield missions are grouped
        const groupingAltitude = 2000000;
        // Springfield, IL bounding box
        const springfieldBounds = {
          west: -89.7501,
          south: 39.5,
          east: -89.4877,
          north: 39.87
        };
        // Center point of Springfield for group marker and zoom
        const springfieldCenter = { lng: -89.6501, lat: 39.7817 };
        const springfieldRectangle = Cesium.Rectangle.fromDegrees(
          springfieldBounds.west,
          springfieldBounds.south,
          springfieldBounds.east,
          springfieldBounds.north
        );
        // Regional bounding box for surrounding area
        const regionalBounds = {
          west: -89.40329365428762,
          south: 40.488271457701906,
          east: -87.62502145653507,
          north: 41.839973864619175
        };
        const regionalCenter = {
          lng: (regionalBounds.west + regionalBounds.east) / 2,
          lat: (regionalBounds.south + regionalBounds.north) / 2
        };
        const regionalRectangle = Cesium.Rectangle.fromDegrees(
          regionalBounds.west,
          regionalBounds.south,
          regionalBounds.east,
          regionalBounds.north
        );

        // 6. Load missions and manage grouping for Springfield
        fetch('missions.json')
          .then(res => res.json())
          .then(missions => {
            const springfieldEntities = [];
            const regionalEntities = [];
            // Create individual mission entities
            missions.forEach(m => {
              const isLocal = (
                m.lng >= springfieldBounds.west &&
                m.lng <= springfieldBounds.east &&
                m.lat >= springfieldBounds.south &&
                m.lat <= springfieldBounds.north
              );
              const entity = viewer.entities.add({
                name: m.name,
                url: m.url,
                position: Cesium.Cartesian3.fromDegrees(m.lng, m.lat, 0),
                billboard: {
                  image: 'https://cdn.jsdelivr.net/npm/cesium@1.119/Build/Cesium/Widgets/Images/marker-pin.png',
                  verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                  scale: 0.66
                },
                label: {
                  text: m.name,
                  font: '20px sans-serif',
                  fillColor: Cesium.Color.WHITE,
                  outlineColor: Cesium.Color.BLACK,
                  outlineWidth: 4,
                  style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                  verticalOrigin: Cesium.VerticalOrigin.TOP,
                  pixelOffset: new Cesium.Cartesian2(0, 10)
                }
              });
              if (isLocal) {
                springfieldEntities.push(entity);
              }
              const isRegional = (
                m.lng >= regionalBounds.west &&
                m.lng <= regionalBounds.east &&
                m.lat >= regionalBounds.south &&
                m.lat <= regionalBounds.north
              );
              if (isRegional) {
                regionalEntities.push(entity);
              }
            });
            // Create a grouped "Local" marker for Springfield region
            const localEntity = viewer.entities.add({
              name: 'Local',
              position: Cesium.Cartesian3.fromDegrees(springfieldCenter.lng, springfieldCenter.lat, 0),
              billboard: {
                image: 'https://cdn.jsdelivr.net/npm/cesium@1.119/Build/Cesium/Widgets/Images/marker-pin.png',
                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                scale: 0.8
              },
              label: {
                text: 'Local',
                font: 'bold 20px sans-serif',
                fillColor: Cesium.Color.WHITE,
                outlineColor: Cesium.Color.BLACK,
                outlineWidth: 3,
                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                verticalOrigin: Cesium.VerticalOrigin.TOP,
                pixelOffset: new Cesium.Cartesian2(0, 12)
              }
            });
            const regionalEntity = viewer.entities.add({
              name: 'Regional',
              position: Cesium.Cartesian3.fromDegrees(regionalCenter.lng, regionalCenter.lat, 0),
              billboard: {
                image: 'https://cdn.jsdelivr.net/npm/cesium@1.119/Build/Cesium/Widgets/Images/marker-pin.png',
                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                scale: 0.8
              },
              label: {
                text: 'Regional',
                font: 'bold 20px sans-serif',
                fillColor: Cesium.Color.CYAN,
                outlineColor: Cesium.Color.BLACK,
                outlineWidth: 3,
                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                verticalOrigin: Cesium.VerticalOrigin.TOP,
                pixelOffset: new Cesium.Cartesian2(0, 48)
              }
            });
            // Initial visibility based on altitude
            const updateGrouping = () => {
              const height = viewer.camera.positionCartographic.height;
              const grouped = height > groupingAltitude;
              localEntity.show = grouped;
              regionalEntity.show = grouped;
              springfieldEntities.forEach(e => e.show = !grouped);
              regionalEntities.forEach(e => e.show = !grouped);
            };
            updateGrouping();
            viewer.camera.changed.addEventListener(updateGrouping);
            // Click handler for navigation and grouping
            const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
            handler.setInputAction(click => {
              const picked = viewer.scene.pick(click.position);
              if (Cesium.defined(picked) && picked.id) {
                if (picked.id === regionalEntity) {
                  viewer.camera.flyTo({ destination: regionalRectangle });
                } else if (picked.id === localEntity) {
                  viewer.camera.flyTo({ destination: springfieldRectangle });
                } else if (picked.id.url) {
                  window.location.href = picked.id.url;
                }
              }
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
          })
          .catch(err => console.error('Failed to load missions.json', err));
    // 7. Label collision avoidance (declutter labels)
    viewer.scene.postRender.addEventListener(() => {
      // Project labels to screen and store their bounding boxes
      const labelEntities = viewer.entities.values.filter(e => e.label && e.show);
      const boxes = [];
      labelEntities.forEach(e => {
        const pos = viewer.scene.cartesianToCanvasCoordinates(
          e.position.getValue(viewer.clock.currentTime)
        );
        if (!pos) return;
        const label = e.label;
        const text = label.text.getValue();
        const fontSize = parseInt(label.font.getValue(), 10) || 20;
        // Approximate text dimensions
        const width = text.length * fontSize * 0.6;
        const height = fontSize;
        const offset = label.pixelOffset.getValue();
        boxes.push({ entity: e,
          left: pos.x + offset.x - width / 2,
          right: pos.x + offset.x + width / 2,
          top: pos.y + offset.y - height,
          bottom: pos.y + offset.y,
          fontSize
        });
      });
      // Simple O(n^2) collision resolution
      for (let i = 0; i < boxes.length; i++) {
        for (let j = i + 1; j < boxes.length; j++) {
          const A = boxes[i], B = boxes[j];
          if (A.left < B.right && A.right > B.left && A.top < B.bottom && A.bottom > B.top) {
            // Nudge the lower-priority label (B) downward
            const oldOffset = B.entity.label.pixelOffset.getValue();
            B.entity.label.pixelOffset = new Cesium.ConstantProperty(
              new Cesium.Cartesian2(oldOffset.x, oldOffset.y + B.fontSize)
            );
            // Update B's box to avoid repeated nudges
            B.top += B.fontSize;
            B.bottom += B.fontSize;
          }
        }
      }
    });
    </script>
</body>

</html>