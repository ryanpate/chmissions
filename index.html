<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cherry Hills Missions Globe</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        /* Brandon Grotesque Font */
        @font-face {
            font-family: 'Brandon Grotesque';
            src: url('assets/fonts/BrandonGrotesque-Regular.woff2') format('woff2'),
                url('assets/fonts/BrandonGrotesque-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: 'Brandon Grotesque';
            src: url('assets/fonts/BrandonGrotesque-Medium.woff2') format('woff2'),
                url('assets/fonts/BrandonGrotesque-Medium.woff') format('woff');
            font-weight: 500;
            font-style: normal;
        }

        @font-face {
            font-family: 'Brandon Grotesque';
            src: url('assets/fonts/BrandonGrotesque-Bold.woff2') format('woff2'),
                url('assets/fonts/BrandonGrotesque-Bold.woff') format('woff');
            font-weight: 600;
            font-style: normal;
        }

        @font-face {
            font-family: 'Brandon Grotesque';
            src: url('assets/fonts/BrandonGrotesque-Black.woff2') format('woff2'),
                url('assets/fonts/BrandonGrotesque-Black.woff') format('woff');
            font-weight: 700;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Brandon Grotesque', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
            background: #000;
            color: #fff;
            user-select: none;
            -webkit-user-select: none;
            cursor: default;
            font-weight: 400;
        }

        #cesiumContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #instructions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 20px;
            border-radius: 10px;
            max-width: 280px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #instructions h2 {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 18px;
            margin-bottom: 12px;
            color: #4A90E2;
            font-weight: 600;
        }

        #instructions p {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 8px;
            color: #ddd;
            font-weight: 400;
        }

        #home-button {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: #4A90E2;
            color: white;
            border: none;
            padding: 25px 50px;
            border-radius: 35px;
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 28px;
            font-weight: 600;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 6px 25px rgba(74, 144, 226, 0.4);
            min-width: 180px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        #home-button:hover {
            background: #357ABD;
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(74, 144, 226, 0.5);
        }

        /* Featured Mission Banner - Right Side Panel */
        #featured-banner {
            position: absolute;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            background: linear-gradient(180deg, #4A90E2, #357ABD);
            padding: 30px 35px;
            border-radius: 20px;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 30px rgba(74, 144, 226, 0.5);
            animation: slideIn 0.5s ease-out;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            text-align: center;
            min-width: 220px;
        }

        #featured-banner:hover {
            transform: translateY(-50%) scale(1.03);
            box-shadow: 0 10px 35px rgba(74, 144, 226, 0.6);
        }

        #featured-banner:active {
            transform: translateY(-50%) scale(0.98);
        }

        #featured-banner.active {
            display: block;
        }

        #featured-banner h3 {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 18px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        #featured-banner p {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 26px;
            font-weight: 600;
            color: white;
            margin: 0 0 15px 0;
            line-height: 1.3;
        }

        #featured-banner::after {
            content: 'TAP TO VIEW';
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 15px;
            letter-spacing: 1px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50%) translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateY(-50%) translateX(0);
            }
        }

        /* Pulsing animation for featured pin */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.3);
                opacity: 0.7;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Full-Screen Content Panel */
        #content-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        #content-frame.active {
            display: flex;
        }

        /* Back button fixed at bottom of content panel */
        #back-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #4A90E2;
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 35px;
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            z-index: 2001;
            transition: all 0.2s ease;
            display: none;
            box-shadow: 0 6px 25px rgba(74, 144, 226, 0.4);
        }

        #back-button:hover {
            background: #357ABD;
        }

        #back-button:active {
            background: #2d6db5;
            transform: scale(0.98);
        }

        #content-frame.active #back-button {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #content-display {
            flex: 1;
            overflow-y: auto;
            color: #333;
            background: #ffffff;
            width: 100%;
            height: 100%;
        }

        #content-display iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        /* Scrollbar styling for content panel */
        #content-display::-webkit-scrollbar {
            width: 12px;
        }

        #content-display::-webkit-scrollbar-track {
            background: #f0f0f0;
        }

        #content-display::-webkit-scrollbar-thumb {
            background: #4A90E2;
            border-radius: 6px;
        }

        #content-display::-webkit-scrollbar-thumb:hover {
            background: #357ABD;
        }

        /* Mission Preview Card */
        #mission-preview {
            position: absolute;
            background: white;
            border-radius: 20px;
            padding: 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 1500;
            display: none;
            width: 320px;
            overflow: hidden;
            transform: translate(-50%, -100%) translateY(-20px);
        }

        #mission-preview.active {
            display: block;
        }

        /* Preview card arrow pointing down to pin */
        #mission-preview::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 15px solid white;
        }

        /* Missionary photo */
        #mission-preview .preview-photo {
            width: 100%;
            height: 280px;
            object-fit: cover;
            object-position: top;
            display: block;
        }

        /* Preview content area */
        #mission-preview .preview-content {
            padding: 20px;
        }

        #mission-preview .preview-name {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            text-align: center;
        }

        #mission-preview .preview-location {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 16px;
            color: #666;
            text-align: center;
            margin-bottom: 15px;
        }

        /* QR code section */
        #mission-preview .preview-qr-section {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        #mission-preview .preview-qr {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            background: white;
            padding: 5px;
            border-radius: 8px;
        }

        #mission-preview .preview-qr-text {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 14px;
            color: #666;
            line-height: 1.4;
        }

        #mission-preview .preview-qr-text strong {
            display: block;
            font-size: 16px;
            color: #333;
            margin-bottom: 3px;
        }

        /* View Info button */
        #mission-preview .preview-cta {
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 30px;
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 18px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        #mission-preview .preview-cta:active {
            transform: scale(0.97);
            background: #2d6db5;
        }

        /* Close hint */
        #mission-preview .preview-hint {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 12px;
            color: #999;
            text-align: center;
            margin-top: 12px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 28px;
            font-weight: 500;
            color: #4A90E2;
            flex-direction: column;
            gap: 20px;
        }

        .loading::before {
            content: '';
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top-color: #4A90E2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .logo {
            width: 150px;
            height: auto;
            margin-bottom: 15px;
        }

        /* Hide Cesium UI elements for kiosk mode */
        .cesium-viewer-toolbar,
        .cesium-viewer-animationContainer,
        .cesium-viewer-timelineContainer,
        .cesium-viewer-bottom,
        .cesium-viewer-fullscreenContainer,
        .cesium-viewer-vrContainer,
        .cesium-viewer-geocoderContainer,
        .cesium-viewer-homeButton,
        .cesium-viewer-sceneModePicker,
        .cesium-viewer-projectionPicker,
        .cesium-viewer-baseLayerPicker,
        .cesium-viewer-navigationHelpButton,
        .cesium-viewer-infoBoxContainer {
            display: none !important;
        }

        .cesium-selection-wrapper {
            display: none !important;
        }

        /* Mission Legend - Bottom Center Horizontal */
        #mission-legend {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 25px;
            border-radius: 10px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 25px;
        }

        #mission-legend h3 {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 16px;
            color: #fff;
            font-weight: 600;
            margin-right: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-family: 'Brandon Grotesque', sans-serif;
        }

        .legend-pin {
            width: 24px;
            height: 32px;
            margin-right: 8px;
            position: relative;
        }

        .legend-pin-shape {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .legend-pin img {
            width: 16px;
            height: 16px;
            transform: rotate(45deg);
        }

        .legend-label {
            color: #ddd;
            font-size: 14px;
            font-weight: 400;
        }

        .legend-count {
            color: #4A90E2;
            font-weight: 600;
            margin-left: 5px;
        }

        /* Touch Feedback - Simple Circle */
        .ripple-container {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(74, 144, 226, 0.4);
            transform: translate(-50%, -50%) scale(0);
            animation: ripple-expand 0.3s ease-out forwards;
            pointer-events: none;
        }

        @keyframes ripple-expand {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0.6;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        /* Enhanced Button States for 65" Touch */
        #back-button {
            position: relative;
            overflow: hidden;
            transition: all 0.15s ease;
            min-width: 120px;
            min-height: 60px;
        }

        #home-button {
            overflow: hidden;
        }

        #home-button:active,
        #back-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.4);
            background: #2d6db5;
        }

        /* Button ripple effect */
        .button-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0);
            animation: button-ripple 0.5s ease-out forwards;
            pointer-events: none;
        }

        @keyframes button-ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Featured Banner Touch Feedback */
        #featured-banner {
            transition: all 0.15s ease;
        }

        #featured-banner:active {
            transform: translateY(-50%) scale(0.97);
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4);
        }

        /* Touch indicator pulse on interactive elements */
        .touch-pulse {
            animation: touch-pulse 0.3s ease-out;
        }

        @keyframes touch-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(74, 144, 226, 0.7);
            }
            100% {
                box-shadow: 0 0 0 20px rgba(74, 144, 226, 0);
            }
        }

        /* Pin touch glow effect */
        .pin-touched {
            filter: drop-shadow(0 0 20px rgba(74, 144, 226, 0.9)) drop-shadow(0 0 40px rgba(74, 144, 226, 0.6));
        }

        /* Global touch feedback overlay */
        .touch-point {
            position: fixed;
            width: 40px;
            height: 40px;
            border: 2px solid rgba(74, 144, 226, 0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            animation: touch-point-expand 0.25s ease-out forwards;
            pointer-events: none;
            z-index: 9998;
        }

        @keyframes touch-point-expand {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0.8;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>

    <!-- Mission Preview Card -->
    <div id="mission-preview">
        <img class="preview-photo" id="preview-photo" src="" alt="Mission Photo">
        <div class="preview-content">
            <div class="preview-name" id="preview-name">Mission Name</div>
            <div class="preview-location" id="preview-location">Location</div>
            <div class="preview-qr-section">
                <img class="preview-qr" id="preview-qr" src="" alt="QR Code">
                <div class="preview-qr-text">
                    <strong>Scan to Learn More</strong>
                    Continue reading on your phone
                </div>
            </div>
            <button class="preview-cta" id="preview-cta">View Info</button>
            <div class="preview-hint">Tap elsewhere to close</div>
        </div>
    </div>

    <!-- Featured Mission Banner -->
    <div id="featured-banner">
        <h3>Featured Mission</h3>
        <p id="featured-mission-name"></p>
    </div>

    <div id="instructions">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 40'%3E%3Ctext x='10' y='40' font-family='Arial, sans-serif' font-size='24' font-weight='bold' fill='%234A90E2'%3ECH Missions%3C/text%3E%3C/svg%3E"
            alt="Logo" class="logo">
        <h2>How to Use</h2>
        <p>üåç <strong>Rotate Globe:</strong> Touch and Drag to Explore</p>
        <p>üîç <strong>Zoom:</strong> Drag 2 Fingers UP/DOWN</p>
        <p>üìç <strong>View Mission:</strong> Touch on Any Pin</p>
        <p>üè† <strong>Reset View:</strong> Touch Home button</p>
    </div>

    <div id="mission-legend">
        <h3>Missions</h3>
        <div class="legend-item">
            <div class="legend-pin">
                <div class="legend-pin-shape">
                    <img src="assets/logo_local.png" alt="Local">
                </div>
            </div>
            <span class="legend-label">Local <span class="legend-count" id="local-count">(0)</span></span>
        </div>
        <div class="legend-item">
            <div class="legend-pin">
                <div class="legend-pin-shape">
                    <img src="assets/logo_regional.png" alt="Regional">
                </div>
            </div>
            <span class="legend-label">Regional <span class="legend-count" id="regional-count">(0)</span></span>
        </div>
        <div class="legend-item">
            <div class="legend-pin">
                <div class="legend-pin-shape">
                    <img src="assets/logo_global.png" alt="Global">
                </div>
            </div>
            <span class="legend-label">Global <span class="legend-count" id="global-count">(0)</span></span>
        </div>
    </div>

    <button id="home-button">üè† Home</button>

    <div id="content-frame">
        <div id="content-display">
            <div class="loading">Loading mission information...</div>
        </div>
        <button id="back-button">‚Üê Back to Globe</button>
    </div>

    <script>
        // Set Cesium Ion access token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI2ZmYxYzgzMi1jMjI0LTRiYWUtYjcyNS1jYTlkZWI4MThhNTEiLCJpZCI6MzIwMTI0LCJpYXQiOjE3NTMzMTg3NDd9.NJ7AlxH_emAHLiDuIA5Uv6khpP6gDHB_zEPTWABcLcM';

        // Load mission data from JSON file
        let missions = [];
        let featuredMission = null;
        let featuredEntity = null;

        // Load featured mission from localStorage (set by admin page), falling back to featured.json
        async function loadFeaturedMission() {
            try {
                // Check localStorage first (written by admin page)
                const stored = localStorage.getItem('featuredMission');
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data && data.name) {
                        featuredMission = data;
                        document.getElementById('featured-mission-name').textContent = featuredMission.name;
                        document.getElementById('featured-banner').classList.add('active');
                    }
                    return; // localStorage takes priority, even if cleared
                }

                // Fall back to featured.json if localStorage has never been set
                const response = await fetch('data/featured.json');
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.name) {
                        featuredMission = data;
                        document.getElementById('featured-mission-name').textContent = featuredMission.name;
                        document.getElementById('featured-banner').classList.add('active');
                    }
                }
            } catch (error) {
                console.log('No featured mission set');
            }
        }

        async function loadMissions() {
            try {
                console.log('Attempting to load missions from data/missions.json...');
                const response = await fetch('data/missions.json');
                console.log('Fetch response:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`Failed to load missions.json: ${response.status}`);
                }

                missions = await response.json();
                console.log('Successfully loaded missions:', missions.length);
                console.log('First mission data:', missions[0]);

                // Load featured mission
                await loadFeaturedMission();

                // Continue with initialization after missions are loaded
                initializeGlobe();
            } catch (error) {
                console.error('Error loading missions.json:', error);
                console.warn('Using fallback hardcoded data');

                // Fallback data (abbreviated for space)
                missions = [
                    {
                        "name": "Nate and Insa Brewer",
                        "lat": 48.210033,
                        "lng": 16.363449,
                        "type": "global",
                        "url": "https://www.cherryhillsfamily.org/missions/global/profile/nate-and-insa-brewer",
                        "localFile": "nate-and-insa-brewer.html"
                    },
                    {
                        "name": "The James Project",
                        "lat": 39.7896428394095,
                        "lng": -89.70436802808422,
                        "type": "local",
                        "url": "https://cherryhillsfamily.org/missions/local/profile/the-james-project",
                        "localFile": "the-james-project.html"
                    }
                ];
                await loadFeaturedMission();
                initializeGlobe();
            }
        }

        // Initialize the globe and all functionality
        function initializeGlobe() {

            // Initialize Cesium viewer
            const viewer = new Cesium.Viewer('cesiumContainer', {
                animation: false,
                baseLayerPicker: false,
                fullscreenButton: false,
                geocoder: false,
                homeButton: false,
                sceneModePicker: false,
                selectionIndicator: false,
                timeline: false,
                navigationHelpButton: false,
                vrButton: false,
                scene3DOnly: true,
                automaticallyTrackDataSourceClocks: false,
                shadows: true,
                shouldAnimate: true
            });

            // Configure atmosphere and lighting
            viewer.scene.globe.enableLighting = true;
            viewer.scene.globe.showGroundAtmosphere = true;
            viewer.scene.fog.enabled = false;
            viewer.scene.skyAtmosphere.show = true;

            // Set the time to current time for accurate day/night
            viewer.clock.currentTime = Cesium.JulianDate.now();
            viewer.clock.shouldAnimate = true;
            viewer.clock.multiplier = 1; // Real-time speed

            // Add moon
            viewer.scene.moon = new Cesium.Moon();

            // Configure sun lighting
            viewer.scene.globe.dynamicAtmosphereLighting = true;
            viewer.scene.globe.dynamicAtmosphereLightingFromSun = true;

            // Add night texture with city lights
            const layers = viewer.scene.imageryLayers;
            const nightLayer = layers.addImageryProvider(
                new Cesium.IonImageryProvider({ assetId: 3812 }) // Earth at Night
            );

            // Make night layer only visible in dark areas
            nightLayer.dayAlpha = 0.0;
            nightLayer.nightAlpha = 1.0;
            nightLayer.brightness = 2.0;

            // Determine initial view based on featured mission
            let initialView;
            if (featuredMission) {
                // Find the featured mission in the missions array
                const featured = missions.find(m => m.name === featuredMission.name);
                if (featured) {
                    // Use a global view that centers the featured location in the screen
                    initialView = {
                        destination: Cesium.Cartesian3.fromDegrees(featured.lng, featured.lat, 12000000),
                        // No offset - pin will be centered
                        orientation: {
                            heading: 0.0,
                            pitch: -Cesium.Math.PI_OVER_TWO, // Looking straight down for global view
                            roll: 0.0
                        }
                    };
                } else {
                    // Fallback to default view if featured mission not found
                    initialView = {
                        destination: Cesium.Cartesian3.fromDegrees(-89.65, 39.8, 15000000),
                        orientation: {
                            heading: 0.0,
                            pitch: -Cesium.Math.PI_OVER_TWO,
                            roll: 0.0
                        }
                    };
                }
            } else {
                // Default view if no featured mission
                initialView = {
                    destination: Cesium.Cartesian3.fromDegrees(-89.65, 39.8, 15000000),
                    orientation: {
                        heading: 0.0,
                        pitch: -Cesium.Math.PI_OVER_TWO,
                        roll: 0.0
                    }
                };
            }

            viewer.scene.camera.setView(initialView);

            // Count missions by type and update legend
            const missionCounts = {
                local: 0,
                regional: 0,
                global: 0
            };

            missions.forEach(mission => {
                const type = mission.type || 'local';
                missionCounts[type]++;
            });

            // Update legend counts
            document.getElementById('local-count').textContent = `(${missionCounts.local})`;
            document.getElementById('regional-count').textContent = `(${missionCounts.regional})`;
            document.getElementById('global-count').textContent = `(${missionCounts.global})`;

            // Create custom pin billboard with actual logo
            const pinCanvas = document.createElement('canvas');
            pinCanvas.width = 48;
            pinCanvas.height = 64;
            const ctx = pinCanvas.getContext('2d');

            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // Function to draw pin with logo
            function drawPinWithLogo(logoImg, isFeatured = false) {
                ctx.clearRect(0, 0, pinCanvas.width, pinCanvas.height);

                // Draw pin shape
                ctx.fillStyle = isFeatured ? '#FFD700' : 'white'; // Gold for featured, white for normal
                ctx.beginPath();
                ctx.arc(24, 24, 20, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(24, 44);
                ctx.lineTo(14, 24);
                ctx.lineTo(34, 24);
                ctx.closePath();
                ctx.fill();

                // Draw white circle background
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(24, 24, 12, 0, Math.PI * 2);
                ctx.fill();

                // Draw logo image
                if (logoImg) {
                    const logoSize = 35;
                    const logoX = 24 - logoSize / 2;
                    const logoY = 24 - logoSize / 2;
                    ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);
                } else {
                    // Fallback to CH text if logo doesn't load
                    ctx.fillStyle = '#4A90E2';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('CH', 24, 24);
                }

                return pinCanvas.toDataURL();
            }

            // Load logos for each mission type
            const logos = {
                global: new Image(),
                regional: new Image(),
                local: new Image()
            };

            let loadedLogos = 0;
            const totalLogos = 3;

            // Function to check if all logos are loaded
            function checkAllLogosLoaded() {
                loadedLogos++;
                if (loadedLogos === totalLogos) {
                    addMissionPins();
                }
            }

            // Load global logo
            logos.global.onload = function () {
                console.log('Global logo loaded');
                checkAllLogosLoaded();
            };
            logos.global.onerror = function () {
                console.warn('Global logo failed to load, will use fallback');
                logos.global = null;
                checkAllLogosLoaded();
            };
            logos.global.src = 'assets/logo_global.png';

            // Load regional logo
            logos.regional.onload = function () {
                console.log('Regional logo loaded');
                checkAllLogosLoaded();
            };
            logos.regional.onerror = function () {
                console.warn('Regional logo failed to load, will use fallback');
                logos.regional = null;
                checkAllLogosLoaded();
            };
            logos.regional.src = 'assets/logo_regional.png';

            // Load local logo
            logos.local.onload = function () {
                console.log('Local logo loaded');
                checkAllLogosLoaded();
            };
            logos.local.onerror = function () {
                console.warn('Local logo failed to load, will use fallback');
                logos.local = null;
                checkAllLogosLoaded();
            };
            logos.local.src = 'assets/logo_local.png';

            // Function to add mission pins (simplified for TV)
            function addMissionPins() {
                missions.forEach((mission, index) => {
                    const missionType = mission.type || 'local';
                    const logoToUse = logos[missionType];

                    // Check if this is the featured mission
                    const isFeatured = featuredMission && featuredMission.name === mission.name;

                    // Create pin image
                    const pinImage = drawPinWithLogo(logoToUse, isFeatured);

                    // Scale for this pin
                    const pinScale = isFeatured ? 1.8 : 1.3;

                    const entity = viewer.entities.add({
                        name: mission.name,
                        position: Cesium.Cartesian3.fromDegrees(mission.lng, mission.lat),
                        billboard: {
                            image: pinImage,
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            scale: pinScale,
                            scaleByDistance: new Cesium.NearFarScalar(1.5e2, isFeatured ? 1.2 : 1.0, 1.5e7, 0.5)
                        },
                        properties: {
                            mission: mission,
                            isFeatured: isFeatured
                        }
                    });

                    // Store featured entity reference
                    if (isFeatured) {
                        featuredEntity = entity;
                        // Start subtle pulse for featured pin
                        startFeaturedPulse(entity, pinScale);
                    }
                });

                // Featured pin pulsing animation (subtle)
                function startFeaturedPulse(entity, baseScale) {
                    let pulseScale = 1.0;
                    let pulseDirection = 1;

                    viewer.scene.preRender.addEventListener(function () {
                        if (entity && entity.billboard && featuredEntity === entity) {
                            pulseScale += 0.003 * pulseDirection;
                            if (pulseScale > 1.15 || pulseScale < 1.0) {
                                pulseDirection *= -1;
                            }
                            entity.billboard.scale = pulseScale * baseScale;
                        }
                    });
                }
            }

            // Handle mouse events
            const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

            // Two-tap preview system state
            let currentPreviewMission = null;
            let currentPreviewEntity = null;
            const previewCard = document.getElementById('mission-preview');

            // Show preview card at screen position
            function showPreviewCard(mission, entity, screenPosition) {
                currentPreviewMission = mission;
                currentPreviewEntity = entity;

                // Update preview content
                document.getElementById('preview-name').textContent = mission.name;
                document.getElementById('preview-location').textContent = getLocationName(mission);

                // Update photo
                const photoImg = document.getElementById('preview-photo');
                if (mission.image) {
                    photoImg.src = mission.image;
                    photoImg.style.display = 'block';
                } else {
                    photoImg.style.display = 'none';
                }

                // Update QR code
                const qrImg = document.getElementById('preview-qr');
                qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(mission.url)}`;

                // Position the preview card above the clicked point
                // Ensure it stays within screen bounds
                let left = screenPosition.x;
                let top = screenPosition.y;

                // Clamp horizontal position
                const cardWidth = 320;
                const minLeft = cardWidth / 2 + 20;
                const maxLeft = window.innerWidth - cardWidth / 2 - 20;
                left = Math.max(minLeft, Math.min(maxLeft, left));

                // Ensure vertical position has room for card (card is ~450px tall + 20px arrow)
                const minTop = 560;
                top = Math.max(minTop, top);

                previewCard.style.left = left + 'px';
                previewCard.style.top = top + 'px';
                previewCard.classList.add('active');

                // Visual feedback: Pulse the selected pin
                if (entity.billboard) {
                    const originalScale = entity.billboard.scale.getValue ? entity.billboard.scale.getValue() : entity.billboard.scale;
                    entity.billboard.scale = originalScale * 1.3;
                    setTimeout(() => {
                        entity.billboard.scale = originalScale * 1.15;
                    }, 150);
                }
            }

            // Hide preview card
            function hidePreviewCard() {
                previewCard.classList.remove('active');
                currentPreviewMission = null;
                currentPreviewEntity = null;
            }

            // Open full content from preview
            function openMissionFromPreview() {
                if (!currentPreviewMission || !currentPreviewEntity) return;

                const mission = currentPreviewMission;
                const entity = currentPreviewEntity;

                hidePreviewCard();

                // Set zoom distance based on mission type
                let zoomDistance;
                switch (mission.type) {
                    case 'local':
                        zoomDistance = 50000;
                        break;
                    case 'regional':
                        zoomDistance = 300000;
                        break;
                    case 'global':
                        zoomDistance = 1000000;
                        break;
                    default:
                        zoomDistance = 500000;
                }

                // Zoom to the pin location
                viewer.flyTo(entity, {
                    duration: 2.0,
                    offset: new Cesium.HeadingPitchRange(
                        0,
                        -Cesium.Math.PI_OVER_FOUR,
                        zoomDistance
                    )
                }).then(function () {
                    setTimeout(function () {
                        lastViewedPosition = {
                            position: viewer.camera.position.clone(),
                            heading: viewer.camera.heading,
                            pitch: viewer.camera.pitch,
                            roll: viewer.camera.roll
                        };
                        showMissionContent(mission);
                    }, 500);
                });
            }

            // Preview CTA button click handler
            document.getElementById('preview-cta').addEventListener('click', function(e) {
                e.stopPropagation();
                openMissionFromPreview();
            });

            // Click anywhere on preview card opens content
            previewCard.addEventListener('click', function(e) {
                e.stopPropagation();
                openMissionFromPreview();
            });

            // Click handler - Two-tap system
            handler.setInputAction(function (click) {
                const pickedObject = viewer.scene.pick(click.position);

                if (Cesium.defined(pickedObject) && pickedObject.id && pickedObject.id.properties) {
                    const mission = pickedObject.id.properties.mission.getValue();
                    const entity = pickedObject.id;

                    // If clicking the same pin that's already previewed, open content
                    if (currentPreviewMission && currentPreviewMission.name === mission.name) {
                        openMissionFromPreview();
                        return;
                    }

                    // Show preview card for this mission
                    showPreviewCard(mission, entity, click.position);

                } else {
                    // Clicked on globe (not a pin) - hide preview if showing
                    if (currentPreviewMission) {
                        hidePreviewCard();
                    }
                }
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            // Home button - updated to respect featured mission
            document.getElementById('home-button').addEventListener('click', () => {
                // Hide preview if showing
                hidePreviewCard();

                if (featuredMission) {
                    // If there's a featured mission, go to global view centered on it
                    const featured = missions.find(m => m.name === featuredMission.name);
                    if (featured) {
                        viewer.camera.flyTo({
                            destination: Cesium.Cartesian3.fromDegrees(featured.lng, featured.lat, 12000000),
                            orientation: {
                                heading: 0.0,
                                pitch: -Cesium.Math.PI_OVER_TWO, // Looking straight down
                                roll: 0.0
                            },
                            duration: 3.0,
                            easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
                        });
                    }
                } else {
                    // Default home view
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(-89.65, 39.8, 15000000),
                        orientation: {
                            heading: 0.0,
                            pitch: -Cesium.Math.PI_OVER_TWO,
                            roll: 0.0
                        },
                        duration: 3.0,
                        easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
                    });
                }
            });

            // Store the last viewed position
            let lastViewedPosition = null;

            // Back button - return to globe
            document.getElementById('back-button').addEventListener('click', () => {
                document.getElementById('content-frame').classList.remove('active');
                hidePreviewCard();

                // Determine where to return to
                let targetView;
                if (featuredMission) {
                    const featured = missions.find(m => m.name === featuredMission.name);
                    if (featured) {
                        targetView = {
                            destination: Cesium.Cartesian3.fromDegrees(featured.lng, featured.lat, 12000000),
                            orientation: {
                                heading: 0.0,
                                pitch: -Cesium.Math.PI_OVER_TWO, // Looking straight down
                                roll: 0.0
                            }
                        };
                    }
                } else {
                    targetView = {
                        destination: Cesium.Cartesian3.fromDegrees(-89.65, 39.8, 15000000),
                        orientation: {
                            heading: 0.0,
                            pitch: -Cesium.Math.PI_OVER_TWO,
                            roll: 0.0
                        }
                    };
                }

                viewer.camera.flyTo({
                    ...targetView,
                    duration: 3.0,
                    easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
                });

                resetInactivityTimer();
            });

            // Get location name from coordinates (approximate)
            function getLocationName(mission) {
                // Map of known mission locations
                const locations = {
                    'Nate and Insa Brewer': 'Vienna, Austria',
                    'The James Project': 'Springfield, IL',
                    'Enos Elementary School': 'Springfield, IL',
                    'First Step Womens Center': 'Springfield, IL',
                    'Washington Street Mission': 'Springfield, IL',
                    'St. Johns Breadline': 'Springfield, IL',
                    'Contact Ministries': 'Springfield, IL',
                    'Powerlight Fest': 'Springfield, IL',
                    'Fellowship of Christian Athletes': 'Springfield, IL',
                    'Refuge Ranch': 'Taylorville, IL',
                    'Matt and Nadia Lohse': 'Chicago, IL',
                    'TJ & Emily Lemons': 'Bloomington, IL',
                    'Bryan & Jonell McKenzie': 'Peoria, IL',
                    'Bill & Sandi Graf': 'New Mexico, USA',
                    'Amigos en Cristo': 'El Paso, TX',
                    'Greg & Vicki Syverson': 'Mexico',
                    'Steve & Rhonda Ashworth': 'Amsterdam, Netherlands',
                    'John & Debbie Coats': 'Phnom Penh, Cambodia',
                    'Scott & Tan Coats': 'Phuket, Thailand',
                    'Jeff & Annie Dieselberg': 'Bangkok, Thailand',
                    'Craig & Allison Fowler': 'Addis Ababa, Ethiopia',
                    'Scott & Cindy Nelsen': 'Baguio, Philippines',
                    'Paul & Queenie Rollet': 'Mindanao, Philippines',
                    'Ray & Susan Stensgard': 'Belgium',
                    'Matt & Heather': 'Hanoi, Vietnam',
                    'el Roi Haiti': 'Haiti',
                    'Melody and Saleh Nassor': 'Zanzibar, Tanzania'
                };
                return locations[mission.name] || 'International';
            }

            // Show mission content (full screen)
            async function showMissionContent(mission) {
                const contentFrame = document.getElementById('content-frame');
                const contentDisplay = document.getElementById('content-display');

                // Show content panel full screen
                contentFrame.classList.add('active');

                try {
                    const response = await fetch(`pages/${mission.localFile}`);
                    const html = await response.text();

                    contentDisplay.innerHTML = `
                        <iframe
                            srcdoc="${html.replace(/"/g, '&quot;')}"
                            style="width: 100%; height: 100%; border: none; background: white;"
                            sandbox="allow-same-origin"
                        ></iframe>
                    `;
                } catch (error) {
                    contentDisplay.innerHTML = `
                        <div style="padding: 40px; text-align: center; font-family: 'Brandon Grotesque', sans-serif;">
                            <h2 style="color: #333; font-size: 28px;">Error Loading Content</h2>
                            <p style="color: #666; font-size: 20px;">Unable to load mission information for ${mission.name}</p>
                        </div>
                    `;
                }

                resetInactivityTimer();
            }

            // Add click handler for featured mission banner
            if (featuredMission) {
                document.getElementById('featured-banner').addEventListener('click', () => {
                    hidePreviewCard();
                    const featured = missions.find(m => m.name === featuredMission.name);
                    if (featured) {
                        // Find the entity for the featured mission
                        const entities = viewer.entities.values;
                        const featuredEntityToClick = entities.find(entity =>
                            entity.properties &&
                            entity.properties.mission &&
                            entity.properties.mission.getValue().name === featured.name
                        );

                        if (featuredEntityToClick) {
                            // Store the last viewed position
                            lastViewedPosition = {
                                position: viewer.camera.position.clone(),
                                heading: viewer.camera.heading,
                                pitch: viewer.camera.pitch,
                                roll: viewer.camera.roll
                            };

                            // Zoom to the featured mission
                            viewer.flyTo(featuredEntityToClick, {
                                duration: 2.0,
                                offset: new Cesium.HeadingPitchRange(
                                    0,
                                    -Cesium.Math.PI_OVER_FOUR,
                                    featured.type === 'local' ? 50000 :
                                        featured.type === 'regional' ? 300000 : 1000000
                                )
                            }).then(function () {
                                setTimeout(function () {
                                    showMissionContent(featured);
                                }, 500);
                            });
                        }
                    }
                });
            }

            // Inactivity timer
            let inactivityTimer;

            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    // Return to featured mission or home
                    document.getElementById('content-frame').classList.remove('active');

                    // Hide preview card if showing
                    document.getElementById('mission-preview').classList.remove('active');

                    if (featuredMission) {
                        const featured = missions.find(m => m.name === featuredMission.name);
                        if (featured) {
                            viewer.camera.flyTo({
                                destination: Cesium.Cartesian3.fromDegrees(featured.lng, featured.lat, 12000000),
                                orientation: {
                                    heading: 0.0,
                                    pitch: -Cesium.Math.PI_OVER_TWO, // Looking straight down
                                    roll: 0.0
                                },
                                duration: 3.0,
                                easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
                            });
                        }
                    } else {
                        viewer.camera.flyTo({
                            destination: Cesium.Cartesian3.fromDegrees(-89.65, 39.8, 15000000),
                            orientation: {
                                heading: 0.0,
                                pitch: -Cesium.Math.PI_OVER_TWO,
                                roll: 0.0
                            },
                            duration: 3.0,
                            easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
                        });
                    }
                }, 600000); // 10 minutes
            }

            // Screensaver timer (30 minutes)
            let screensaverTimer;

            function resetScreensaverTimer() {
                clearTimeout(screensaverTimer);
                screensaverTimer = setTimeout(() => {
                    window.location.href = 'screensaver.html';
                }, 1800000); // 30 minutes
            }

            // Add screensaver reset to all interactions
            document.addEventListener('click', resetScreensaverTimer);
            document.addEventListener('mousemove', resetScreensaverTimer);
            document.addEventListener('touchstart', resetScreensaverTimer);
            document.addEventListener('wheel', resetScreensaverTimer);

            // Initialize screensaver timer
            resetScreensaverTimer();

            // Reset timer on any interaction
            document.addEventListener('click', resetInactivityTimer);
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('wheel', resetInactivityTimer);

            // Initial timer
            resetInactivityTimer();

            // Disable double-click zoom
            viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);

            // Setup touch feedback for canvas interactions
            setupCanvasTouchFeedback(viewer);

            // Set minimum and maximum zoom distances
            viewer.scene.screenSpaceCameraController.minimumZoomDistance = 10000;
            viewer.scene.screenSpaceCameraController.maximumZoomDistance = 30000000;

            // Enable smooth camera movement
            viewer.scene.screenSpaceCameraController.enableTilt = true;
            viewer.scene.screenSpaceCameraController.enableLook = false;

            // ============================================
            // SLOW GLOBE AUTO-ROTATE WHEN IDLE
            // ============================================

            let isRotating = false;
            let rotationStartTimer = null;
            let lastRotationTime = Date.now();
            const ROTATION_SPEED = 0.05; // Degrees per frame (very slow)
            const IDLE_BEFORE_ROTATE = 30000; // 30 seconds before starting rotation

            // Start globe rotation
            function startGlobeRotation() {
                if (isRotating) return;

                // Don't rotate if content panel or preview is open
                if (document.getElementById('content-frame').classList.contains('active') ||
                    document.getElementById('mission-preview').classList.contains('active')) {
                    return;
                }

                isRotating = true;
                lastRotationTime = Date.now();
                console.log('Globe rotation started');
            }

            // Stop globe rotation
            function stopGlobeRotation() {
                isRotating = false;
                clearTimeout(rotationStartTimer);
                console.log('Globe rotation stopped');
            }

            // Schedule rotation to start after idle period
            function scheduleRotationStart() {
                clearTimeout(rotationStartTimer);
                rotationStartTimer = setTimeout(() => {
                    startGlobeRotation();
                }, IDLE_BEFORE_ROTATE);
            }

            // Rotation render loop
            viewer.scene.preRender.addEventListener(function(scene, time) {
                if (!isRotating) return;

                // Don't rotate if content or preview is showing
                if (document.getElementById('content-frame').classList.contains('active') ||
                    document.getElementById('mission-preview').classList.contains('active')) {
                    stopGlobeRotation();
                    return;
                }

                // Calculate smooth rotation based on elapsed time
                const now = Date.now();
                const deltaTime = (now - lastRotationTime) / 1000; // seconds
                lastRotationTime = now;

                // Rotate camera around the globe (heading change)
                viewer.camera.rotateRight(Cesium.Math.toRadians(ROTATION_SPEED));
            });

            // Stop rotation and reschedule on any interaction
            function handleUserInteraction() {
                stopGlobeRotation();
                scheduleRotationStart();
            }

            // Listen for user interactions to stop/restart rotation
            document.addEventListener('click', handleUserInteraction);
            document.addEventListener('touchstart', handleUserInteraction, { passive: true });
            document.addEventListener('mousemove', handleUserInteraction);
            document.addEventListener('wheel', handleUserInteraction, { passive: true });

            // Also listen on the Cesium canvas specifically
            viewer.scene.canvas.addEventListener('pointerdown', handleUserInteraction);
            viewer.scene.canvas.addEventListener('pointermove', handleUserInteraction);

            // Start the idle timer initially
            scheduleRotationStart();
        }

        // Auto-refresh functionality
        function setupAutoRefresh() {
            // Check if we have a stored refresh timestamp
            const lastRefresh = localStorage.getItem('lastRefreshTime');
            const now = Date.now();
            const twelveHours = 12 * 60 * 60 * 1000; // 12 hours in milliseconds
            
            if (!lastRefresh) {
                // First time load, store the current time
                localStorage.setItem('lastRefreshTime', now.toString());
            } else {
                const timeSinceRefresh = now - parseInt(lastRefresh);
                
                // If it's been more than 12 hours, refresh the page
                if (timeSinceRefresh >= twelveHours) {
                    localStorage.setItem('lastRefreshTime', now.toString());
                    window.location.reload(true); // Force reload from server
                    return; // Stop execution since page is reloading
                }
                
                // Calculate time until next refresh
                const timeUntilRefresh = twelveHours - timeSinceRefresh;
                
                // Set timeout for the remaining time
                setTimeout(() => {
                    localStorage.setItem('lastRefreshTime', Date.now().toString());
                    window.location.reload(true);
                }, timeUntilRefresh);
            }
            
            // Also set a recurring 12-hour interval as a backup
            setInterval(() => {
                localStorage.setItem('lastRefreshTime', Date.now().toString());
                window.location.reload(true);
            }, twelveHours);
        }
        
        // Setup auto-refresh
        setupAutoRefresh();

        // ============================================
        // TOUCH FEEDBACK SYSTEM FOR 65" TOUCHSCREEN
        // ============================================

        // Create ripple effect at touch point
        function createRipple(x, y, size = 200) {
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.style.width = size + 'px';
            ripple.style.height = size + 'px';
            document.body.appendChild(ripple);

            // Remove after animation completes
            setTimeout(() => ripple.remove(), 600);
        }

        // Create touch point indicator
        function createTouchPoint(x, y) {
            const touchPoint = document.createElement('div');
            touchPoint.className = 'touch-point';
            touchPoint.style.left = x + 'px';
            touchPoint.style.top = y + 'px';
            document.body.appendChild(touchPoint);

            // Remove after animation completes
            setTimeout(() => touchPoint.remove(), 400);
        }

        // Create button ripple effect
        function createButtonRipple(event, button) {
            const rect = button.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            const ripple = document.createElement('span');
            ripple.className = 'button-ripple';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.style.width = '20px';
            ripple.style.height = '20px';

            button.appendChild(ripple);

            setTimeout(() => ripple.remove(), 500);
        }

        // Global touch/click feedback
        function handleGlobalTouch(event) {
            const x = event.clientX || (event.touches && event.touches[0].clientX);
            const y = event.clientY || (event.touches && event.touches[0].clientY);

            if (x && y) {
                createTouchPoint(x, y);
                createRipple(x, y);
            }
        }

        // Add touch feedback to buttons
        function setupButtonFeedback() {
            const buttons = document.querySelectorAll('#home-button, #back-button, #featured-banner');

            buttons.forEach(button => {
                button.addEventListener('click', function(e) {
                    createButtonRipple(e, this);
                    this.classList.add('touch-pulse');
                    setTimeout(() => this.classList.remove('touch-pulse'), 300);
                });

                button.addEventListener('touchstart', function(e) {
                    this.classList.add('touch-pulse');
                }, { passive: true });

                button.addEventListener('touchend', function(e) {
                    setTimeout(() => this.classList.remove('touch-pulse'), 150);
                }, { passive: true });
            });
        }

        // Initialize touch feedback on Cesium canvas for pin interactions
        function setupCanvasTouchFeedback(viewer) {
            const canvas = viewer.scene.canvas;

            canvas.addEventListener('click', function(e) {
                createTouchPoint(e.clientX, e.clientY);

                // Check if we clicked on a pin
                const pickedObject = viewer.scene.pick(new Cesium.Cartesian2(e.clientX, e.clientY));
                if (Cesium.defined(pickedObject) && pickedObject.id && pickedObject.id.billboard) {
                    // Create larger ripple for pin selection
                    createRipple(e.clientX, e.clientY, 300);
                } else {
                    // Standard ripple for globe interaction
                    createRipple(e.clientX, e.clientY, 150);
                }
            });

            canvas.addEventListener('touchstart', function(e) {
                if (e.touches && e.touches[0]) {
                    const touch = e.touches[0];
                    createTouchPoint(touch.clientX, touch.clientY);
                }
            }, { passive: true });
        }

        // Setup all touch feedback after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setupButtonFeedback();
        });

        // Start loading missions when page loads
        loadMissions();
    </script>
</body>

</html>