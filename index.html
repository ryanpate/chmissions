<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cherry Hills Missions Globe</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        /* Brandon Grotesque Font */
        @font-face {
            font-family: 'Brandon Grotesque';
            src: url('assets/fonts/BrandonGrotesque-Regular.woff2') format('woff2'),
                url('assets/fonts/BrandonGrotesque-Regular.woff') format('woff');
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: 'Brandon Grotesque';
            src: url('assets/fonts/BrandonGrotesque-Medium.woff2') format('woff2'),
                url('assets/fonts/BrandonGrotesque-Medium.woff') format('woff');
            font-weight: 500;
            font-style: normal;
        }

        @font-face {
            font-family: 'Brandon Grotesque';
            src: url('assets/fonts/BrandonGrotesque-Bold.woff2') format('woff2'),
                url('assets/fonts/BrandonGrotesque-Bold.woff') format('woff');
            font-weight: 600;
            font-style: normal;
        }

        @font-face {
            font-family: 'Brandon Grotesque';
            src: url('assets/fonts/BrandonGrotesque-Black.woff2') format('woff2'),
                url('assets/fonts/BrandonGrotesque-Black.woff') format('woff');
            font-weight: 700;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Brandon Grotesque', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            overflow: hidden;
            background: #000;
            color: #fff;
            user-select: none;
            -webkit-user-select: none;
            cursor: default;
            font-weight: 400;
        }

        #cesiumContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #instructions {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            max-width: 300px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #instructions h2 {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 20px;
            margin-bottom: 15px;
            color: #4A90E2;
            font-weight: 600;
        }

        #instructions p {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
            color: #ddd;
            font-weight: 400;
        }

        #home-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #4A90E2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        #home-button:hover {
            background: #357ABD;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.4);
        }

        /* Featured Mission Banner */
        #featured-banner {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #4A90E2, #357ABD);
            padding: 12px 30px;
            border-radius: 30px;
            z-index: 1000;
            display: none;
            box-shadow: 0 6px 20px rgba(74, 144, 226, 0.5);
            animation: slideDown 0.5s ease-out;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        #featured-banner:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.6);
        }

        #featured-banner.active {
            display: block;
        }

        #featured-banner h3 {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #featured-banner p {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Pulsing animation for featured pin */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.3);
                opacity: 0.7;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        #content-frame {
            position: absolute;
            top: 0;
            left: 100%;
            width: 100%;
            height: 100%;
            background: white;
            transition: left 0.5s ease;
            z-index: 2000;
        }

        #content-frame.active {
            left: 0;
        }

        #back-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #4A90E2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            z-index: 2001;
            transition: all 0.3s ease;
            display: none;
        }

        #back-button:hover {
            background: #357ABD;
            transform: translateY(-2px);
        }

        #content-frame.active #back-button {
            display: block;
        }

        #content-display {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            color: #333;
            background: #f5f5f5;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 24px;
            font-weight: 500;
            color: #4A90E2;
        }

        .logo {
            width: 150px;
            height: auto;
            margin-bottom: 20px;
        }

        /* Hide Cesium UI elements for kiosk mode */
        .cesium-viewer-toolbar,
        .cesium-viewer-animationContainer,
        .cesium-viewer-timelineContainer,
        .cesium-viewer-bottom,
        .cesium-viewer-fullscreenContainer,
        .cesium-viewer-vrContainer,
        .cesium-viewer-geocoderContainer,
        .cesium-viewer-homeButton,
        .cesium-viewer-sceneModePicker,
        .cesium-viewer-projectionPicker,
        .cesium-viewer-baseLayerPicker,
        .cesium-viewer-navigationHelpButton,
        .cesium-viewer-infoBoxContainer {
            display: none !important;
        }

        .cesium-selection-wrapper {
            display: none !important;
        }

        /* Mission Legend */
        #mission-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #mission-legend h3 {
            font-family: 'Brandon Grotesque', sans-serif;
            font-size: 18px;
            margin-bottom: 15px;
            color: #fff;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-family: 'Brandon Grotesque', sans-serif;
        }

        .legend-pin {
            width: 24px;
            height: 32px;
            margin-right: 12px;
            position: relative;
        }

        .legend-pin-shape {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .legend-pin img {
            width: 16px;
            height: 16px;
            transform: rotate(45deg);
        }

        .legend-label {
            color: #ddd;
            font-size: 14px;
            font-weight: 400;
        }

        .legend-count {
            color: #4A90E2;
            font-weight: 600;
            margin-left: 8px;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>

    <!-- Featured Mission Banner -->
    <div id="featured-banner">
        <h3>Featured Mission</h3>
        <p id="featured-mission-name"></p>
    </div>

    <div id="instructions">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 40'%3E%3Ctext x='10' y='40' font-family='Arial, sans-serif' font-size='24' font-weight='bold' fill='%234A90E2'%3ECH Missions%3C/text%3E%3C/svg%3E"
            alt="Logo" class="logo">
        <h2>How to Use</h2>
        <p>🌍 <strong>Rotate Globe:</strong> Touch and Drag to Explore</p>
        <p>🔍 <strong>Zoom:</strong> Drag 2 Fingers UP/DOWN</p>
        <p>📍 <strong>View Mission:</strong> Touch on Any Pin</p>
        <p>🏠 <strong>Reset View:</strong> Touch Home button</p>
    </div>

    <div id="mission-legend">
        <h3>Missions</h3>
        <div class="legend-item">
            <div class="legend-pin">
                <div class="legend-pin-shape">
                    <img src="assets/logo_local.png" alt="Local">
                </div>
            </div>
            <span class="legend-label">Local <span class="legend-count" id="local-count">(0)</span></span>
        </div>
        <div class="legend-item">
            <div class="legend-pin">
                <div class="legend-pin-shape">
                    <img src="assets/logo_regional.png" alt="Regional">
                </div>
            </div>
            <span class="legend-label">Regional <span class="legend-count" id="regional-count">(0)</span></span>
        </div>
        <div class="legend-item">
            <div class="legend-pin">
                <div class="legend-pin-shape">
                    <img src="assets/logo_global.png" alt="Global">
                </div>
            </div>
            <span class="legend-label">Global <span class="legend-count" id="global-count">(0)</span></span>
        </div>
    </div>

    <button id="home-button">🏠 Home</button>

    <div id="content-frame">
        <button id="back-button">← Return to Map</button>
        <div id="content-display">
            <div class="loading">Loading mission information...</div>
        </div>
    </div>

    <script>
        // Set Cesium Ion access token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI2ZmYxYzgzMi1jMjI0LTRiYWUtYjcyNS1jYTlkZWI4MThhNTEiLCJpZCI6MzIwMTI0LCJpYXQiOjE3NTMzMTg3NDd9.NJ7AlxH_emAHLiDuIA5Uv6khpP6gDHB_zEPTWABcLcM';

        // Load mission data from JSON file
        let missions = [];
        let featuredMission = null;
        let featuredEntity = null;

        // Load featured mission from localStorage
        function loadFeaturedMission() {
            const stored = localStorage.getItem('featuredMission');
            if (stored) {
                featuredMission = JSON.parse(stored);
                // Display featured mission banner
                if (featuredMission) {
                    document.getElementById('featured-mission-name').textContent = featuredMission.name;
                    document.getElementById('featured-banner').classList.add('active');
                }
            }
        }

        async function loadMissions() {
            try {
                console.log('Attempting to load missions from data/missions.json...');
                const response = await fetch('data/missions.json');
                console.log('Fetch response:', response.status, response.statusText);

                if (!response.ok) {
                    throw new Error(`Failed to load missions.json: ${response.status}`);
                }

                missions = await response.json();
                console.log('Successfully loaded missions:', missions.length);
                console.log('First mission data:', missions[0]);

                // Load featured mission
                loadFeaturedMission();

                // Continue with initialization after missions are loaded
                initializeGlobe();
            } catch (error) {
                console.error('Error loading missions.json:', error);
                console.warn('Using fallback hardcoded data');

                // Fallback data (abbreviated for space)
                missions = [
                    {
                        "name": "Nate and Insa Brewer",
                        "lat": 48.210033,
                        "lng": 16.363449,
                        "type": "global",
                        "url": "https://www.cherryhillsfamily.org/missions/global/profile/nate-and-insa-brewer",
                        "localFile": "nate-and-insa-brewer.html"
                    },
                    {
                        "name": "The James Project",
                        "lat": 39.7896428394095,
                        "lng": -89.70436802808422,
                        "type": "local",
                        "url": "https://cherryhillsfamily.org/missions/local/profile/the-james-project",
                        "localFile": "the-james-project.html"
                    }
                ];
                loadFeaturedMission();
                initializeGlobe();
            }
        }

        // Initialize the globe and all functionality
        function initializeGlobe() {

            // Initialize Cesium viewer
            const viewer = new Cesium.Viewer('cesiumContainer', {
                animation: false,
                baseLayerPicker: false,
                fullscreenButton: false,
                geocoder: false,
                homeButton: false,
                sceneModePicker: false,
                selectionIndicator: false,
                timeline: false,
                navigationHelpButton: false,
                vrButton: false,
                scene3DOnly: true,
                automaticallyTrackDataSourceClocks: false,
                shadows: true,
                shouldAnimate: true
            });

            // Configure atmosphere and lighting
            viewer.scene.globe.enableLighting = true;
            viewer.scene.globe.showGroundAtmosphere = true;
            viewer.scene.fog.enabled = false;
            viewer.scene.skyAtmosphere.show = true;

            // Set the time to current time for accurate day/night
            viewer.clock.currentTime = Cesium.JulianDate.now();
            viewer.clock.shouldAnimate = true;
            viewer.clock.multiplier = 1; // Real-time speed

            // Add moon
            viewer.scene.moon = new Cesium.Moon();

            // Configure sun lighting
            viewer.scene.globe.dynamicAtmosphereLighting = true;
            viewer.scene.globe.dynamicAtmosphereLightingFromSun = true;

            // Add night texture with city lights
            const layers = viewer.scene.imageryLayers;
            const nightLayer = layers.addImageryProvider(
                new Cesium.IonImageryProvider({ assetId: 3812 }) // Earth at Night
            );

            // Make night layer only visible in dark areas
            nightLayer.dayAlpha = 0.0;
            nightLayer.nightAlpha = 1.0;
            nightLayer.brightness = 2.0;

            // Determine initial view based on featured mission
            let initialView;
            if (featuredMission) {
                // Find the featured mission in the missions array
                const featured = missions.find(m => m.name === featuredMission.name);
                if (featured) {
                    // Use a global view that centers the featured location in the screen
                    initialView = {
                        destination: Cesium.Cartesian3.fromDegrees(featured.lng, featured.lat, 12000000),
                        // No offset - pin will be centered
                        orientation: {
                            heading: 0.0,
                            pitch: -Cesium.Math.PI_OVER_TWO, // Looking straight down for global view
                            roll: 0.0
                        }
                    };
                } else {
                    // Fallback to default view if featured mission not found
                    initialView = {
                        destination: Cesium.Cartesian3.fromDegrees(-89.65, 39.8, 15000000),
                        orientation: {
                            heading: 0.0,
                            pitch: -Cesium.Math.PI_OVER_TWO,
                            roll: 0.0
                        }
                    };
                }
            } else {
                // Default view if no featured mission
                initialView = {
                    destination: Cesium.Cartesian3.fromDegrees(-89.65, 39.8, 15000000),
                    orientation: {
                        heading: 0.0,
                        pitch: -Cesium.Math.PI_OVER_TWO,
                        roll: 0.0
                    }
                };
            }

            viewer.scene.camera.setView(initialView);

            // Count missions by type and update legend
            const missionCounts = {
                local: 0,
                regional: 0,
                global: 0
            };

            missions.forEach(mission => {
                const type = mission.type || 'local';
                missionCounts[type]++;
            });

            // Update legend counts
            document.getElementById('local-count').textContent = `(${missionCounts.local})`;
            document.getElementById('regional-count').textContent = `(${missionCounts.regional})`;
            document.getElementById('global-count').textContent = `(${missionCounts.global})`;

            // Create custom pin billboard with actual logo
            const pinCanvas = document.createElement('canvas');
            pinCanvas.width = 48;
            pinCanvas.height = 64;
            const ctx = pinCanvas.getContext('2d');

            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';

            // Function to draw pin with logo
            function drawPinWithLogo(logoImg, isFeatured = false) {
                ctx.clearRect(0, 0, pinCanvas.width, pinCanvas.height);

                // Draw pin shape
                ctx.fillStyle = isFeatured ? '#FFD700' : 'white'; // Gold for featured, white for normal
                ctx.beginPath();
                ctx.arc(24, 24, 20, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(24, 44);
                ctx.lineTo(14, 24);
                ctx.lineTo(34, 24);
                ctx.closePath();
                ctx.fill();

                // Draw white circle background
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(24, 24, 12, 0, Math.PI * 2);
                ctx.fill();

                // Draw logo image
                if (logoImg) {
                    const logoSize = 35;
                    const logoX = 24 - logoSize / 2;
                    const logoY = 24 - logoSize / 2;
                    ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);
                } else {
                    // Fallback to CH text if logo doesn't load
                    ctx.fillStyle = '#4A90E2';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('CH', 24, 24);
                }

                return pinCanvas.toDataURL();
            }

            // Load logos for each mission type
            const logos = {
                global: new Image(),
                regional: new Image(),
                local: new Image()
            };

            let loadedLogos = 0;
            const totalLogos = 3;

            // Function to check if all logos are loaded
            function checkAllLogosLoaded() {
                loadedLogos++;
                if (loadedLogos === totalLogos) {
                    addMissionPins();
                }
            }

            // Load global logo
            logos.global.onload = function () {
                console.log('Global logo loaded');
                checkAllLogosLoaded();
            };
            logos.global.onerror = function () {
                console.warn('Global logo failed to load, will use fallback');
                logos.global = null;
                checkAllLogosLoaded();
            };
            logos.global.src = 'assets/logo_global.png';

            // Load regional logo
            logos.regional.onload = function () {
                console.log('Regional logo loaded');
                checkAllLogosLoaded();
            };
            logos.regional.onerror = function () {
                console.warn('Regional logo failed to load, will use fallback');
                logos.regional = null;
                checkAllLogosLoaded();
            };
            logos.regional.src = 'assets/logo_regional.png';

            // Load local logo
            logos.local.onload = function () {
                console.log('Local logo loaded');
                checkAllLogosLoaded();
            };
            logos.local.onerror = function () {
                console.warn('Local logo failed to load, will use fallback');
                logos.local = null;
                checkAllLogosLoaded();
            };
            logos.local.src = 'assets/logo_local.png';

            // Function to add mission pins
            function addMissionPins() {
                missions.forEach((mission) => {
                    const missionType = mission.type || 'local';
                    const logoToUse = logos[missionType];

                    // Check if this is the featured mission
                    const isFeatured = featuredMission && featuredMission.name === mission.name;

                    // Create pin image
                    const pinImage = drawPinWithLogo(logoToUse, isFeatured);

                    const entity = viewer.entities.add({
                        name: mission.name,
                        position: Cesium.Cartesian3.fromDegrees(mission.lng, mission.lat),
                        billboard: {
                            image: pinImage,
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            scale: isFeatured ? 2.0 : 1.5, // Larger scale for featured
                            scaleByDistance: new Cesium.NearFarScalar(1.5e2, isFeatured ? 1.2 : 1.0, 1.5e7, 0.5)
                        },
                        properties: {
                            mission: mission,
                            isFeatured: isFeatured
                        }
                    });

                    // Store featured entity reference
                    if (isFeatured) {
                        featuredEntity = entity;

                        // Add slower pulsing animation to featured pin
                        let pulseScale = 1.0;
                        let pulseDirection = 1;

                        viewer.scene.preRender.addEventListener(function () {
                            if (featuredEntity && featuredEntity.billboard) {
                                pulseScale += 0.002 * pulseDirection; // Reduced from 0.015 to 0.005 for slower animation
                                if (pulseScale > 1.2 || pulseScale < 1.0) { // Reduced max scale from 1.3 to 1.2 for subtler effect
                                    pulseDirection *= -1;
                                }
                                featuredEntity.billboard.scale = pulseScale * 2.0;
                            }
                        });
                    }
                });
            }

            // Handle mouse events
            const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

            // Click handler
            handler.setInputAction(function (click) {
                const pickedObject = viewer.scene.pick(click.position);

                if (Cesium.defined(pickedObject) && pickedObject.id && pickedObject.id.properties) {
                    const mission = pickedObject.id.properties.mission.getValue();
                    const entity = pickedObject.id;

                    // Set zoom distance based on mission type
                    let zoomDistance;
                    switch (mission.type) {
                        case 'local':
                            zoomDistance = 50000; // 50km for local
                            break;
                        case 'regional':
                            zoomDistance = 300000; // 300km for regional
                            break;
                        case 'global':
                            zoomDistance = 1000000; // 1000km for global
                            break;
                        default:
                            zoomDistance = 500000; // 500km default
                    }

                    // Zoom to the pin location
                    viewer.flyTo(entity, {
                        duration: 2.0,
                        offset: new Cesium.HeadingPitchRange(
                            0,
                            -Cesium.Math.PI_OVER_FOUR,
                            zoomDistance
                        )
                    }).then(function () {
                        setTimeout(function () {
                            lastViewedPosition = {
                                position: viewer.camera.position.clone(),
                                heading: viewer.camera.heading,
                                pitch: viewer.camera.pitch,
                                roll: viewer.camera.roll
                            };
                            showMissionContent(mission);
                        }, 500);
                    });
                }
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            // Home button - updated to respect featured mission
            document.getElementById('home-button').addEventListener('click', () => {
                if (featuredMission) {
                    // If there's a featured mission, go to global view centered on it
                    const featured = missions.find(m => m.name === featuredMission.name);
                    if (featured) {
                        viewer.camera.flyTo({
                            destination: Cesium.Cartesian3.fromDegrees(featured.lng, featured.lat, 12000000),
                            orientation: {
                                heading: 0.0,
                                pitch: -Cesium.Math.PI_OVER_TWO, // Looking straight down
                                roll: 0.0
                            },
                            duration: 3.0,
                            easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
                        });
                    }
                } else {
                    // Default home view
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(-89.65, 39.8, 15000000),
                        orientation: {
                            heading: 0.0,
                            pitch: -Cesium.Math.PI_OVER_TWO,
                            roll: 0.0
                        },
                        duration: 3.0,
                        easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
                    });
                }
            });

            // Store the last viewed position
            let lastViewedPosition = null;

            // Back button - updated to return to featured or home
            document.getElementById('back-button').addEventListener('click', () => {
                document.getElementById('content-frame').classList.remove('active');

                // Determine where to return to
                let targetView;
                if (featuredMission) {
                    const featured = missions.find(m => m.name === featuredMission.name);
                    if (featured) {
                        targetView = {
                            destination: Cesium.Cartesian3.fromDegrees(featured.lng, featured.lat, 12000000),
                            orientation: {
                                heading: 0.0,
                                pitch: -Cesium.Math.PI_OVER_TWO, // Looking straight down
                                roll: 0.0
                            }
                        };
                    }
                } else {
                    targetView = {
                        destination: Cesium.Cartesian3.fromDegrees(-89.65, 39.8, 15000000),
                        orientation: {
                            heading: 0.0,
                            pitch: -Cesium.Math.PI_OVER_TWO,
                            roll: 0.0
                        }
                    };
                }

                viewer.camera.flyTo({
                    ...targetView,
                    duration: 3.0,
                    easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
                });

                resetInactivityTimer();
            });

            // Show mission content
            async function showMissionContent(mission) {
                const contentFrame = document.getElementById('content-frame');
                const contentDisplay = document.getElementById('content-display');

                contentFrame.classList.add('active');

                try {
                    const response = await fetch(`pages/${mission.localFile}`);
                    const html = await response.text();

                    contentDisplay.innerHTML = `
                        <iframe 
                            srcdoc="${html.replace(/"/g, '&quot;')}" 
                            style="width: 100%; height: 100%; border: none; background: white;"
                            sandbox="allow-same-origin"
                        ></iframe>
                    `;
                } catch (error) {
                    contentDisplay.innerHTML = `
                        <div style="padding: 40px; text-align: center;">
                            <h2>Error Loading Content</h2>
                            <p>Unable to load mission information for ${mission.name}</p>
                        </div>
                    `;
                }

                resetInactivityTimer();
            }

            // Add click handler for featured mission banner
            if (featuredMission) {
                document.getElementById('featured-banner').addEventListener('click', () => {
                    const featured = missions.find(m => m.name === featuredMission.name);
                    if (featured) {
                        // Find the entity for the featured mission
                        const entities = viewer.entities.values;
                        const featuredEntityToClick = entities.find(entity =>
                            entity.properties &&
                            entity.properties.mission &&
                            entity.properties.mission.getValue().name === featured.name
                        );

                        if (featuredEntityToClick) {
                            // Store the last viewed position
                            lastViewedPosition = {
                                position: viewer.camera.position.clone(),
                                heading: viewer.camera.heading,
                                pitch: viewer.camera.pitch,
                                roll: viewer.camera.roll
                            };

                            // Zoom to the featured mission
                            viewer.flyTo(featuredEntityToClick, {
                                duration: 2.0,
                                offset: new Cesium.HeadingPitchRange(
                                    0,
                                    -Cesium.Math.PI_OVER_FOUR,
                                    featured.type === 'local' ? 50000 :
                                        featured.type === 'regional' ? 300000 : 1000000
                                )
                            }).then(function () {
                                setTimeout(function () {
                                    showMissionContent(featured);
                                }, 500);
                            });
                        }
                    }
                });
            }

            // Inactivity timer
            let inactivityTimer;

            function resetInactivityTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    // Return to featured mission or home
                    document.getElementById('content-frame').classList.remove('active');

                    if (featuredMission) {
                        const featured = missions.find(m => m.name === featuredMission.name);
                        if (featured) {
                            viewer.camera.flyTo({
                                destination: Cesium.Cartesian3.fromDegrees(featured.lng, featured.lat, 12000000),
                                orientation: {
                                    heading: 0.0,
                                    pitch: -Cesium.Math.PI_OVER_TWO, // Looking straight down
                                    roll: 0.0
                                },
                                duration: 3.0,
                                easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
                            });
                        }
                    } else {
                        viewer.camera.flyTo({
                            destination: Cesium.Cartesian3.fromDegrees(-89.65, 39.8, 15000000),
                            orientation: {
                                heading: 0.0,
                                pitch: -Cesium.Math.PI_OVER_TWO,
                                roll: 0.0
                            },
                            duration: 3.0,
                            easingFunction: Cesium.EasingFunction.CUBIC_IN_OUT
                        });
                    }
                }, 600000); // 10 minutes
            }

            // Screensaver timer (30 minutes)
            let screensaverTimer;

            function resetScreensaverTimer() {
                clearTimeout(screensaverTimer);
                screensaverTimer = setTimeout(() => {
                    window.location.href = 'screensaver.html';
                }, 1800000); // 30 minutes
            }

            // Add screensaver reset to all interactions
            document.addEventListener('click', resetScreensaverTimer);
            document.addEventListener('mousemove', resetScreensaverTimer);
            document.addEventListener('touchstart', resetScreensaverTimer);
            document.addEventListener('wheel', resetScreensaverTimer);

            // Initialize screensaver timer
            resetScreensaverTimer();

            // Reset timer on any interaction
            document.addEventListener('click', resetInactivityTimer);
            document.addEventListener('mousemove', resetInactivityTimer);
            document.addEventListener('wheel', resetInactivityTimer);

            // Initial timer
            resetInactivityTimer();

            // Disable double-click zoom
            viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);

            // Set minimum and maximum zoom distances
            viewer.scene.screenSpaceCameraController.minimumZoomDistance = 10000;
            viewer.scene.screenSpaceCameraController.maximumZoomDistance = 30000000;

            // Enable smooth camera movement
            viewer.scene.screenSpaceCameraController.enableTilt = true;
            viewer.scene.screenSpaceCameraController.enableLook = false;
        }

        // Auto-refresh functionality
        function setupAutoRefresh() {
            // Check if we have a stored refresh timestamp
            const lastRefresh = localStorage.getItem('lastRefreshTime');
            const now = Date.now();
            const twelveHours = 12 * 60 * 60 * 1000; // 12 hours in milliseconds
            
            if (!lastRefresh) {
                // First time load, store the current time
                localStorage.setItem('lastRefreshTime', now.toString());
            } else {
                const timeSinceRefresh = now - parseInt(lastRefresh);
                
                // If it's been more than 12 hours, refresh the page
                if (timeSinceRefresh >= twelveHours) {
                    localStorage.setItem('lastRefreshTime', now.toString());
                    window.location.reload(true); // Force reload from server
                    return; // Stop execution since page is reloading
                }
                
                // Calculate time until next refresh
                const timeUntilRefresh = twelveHours - timeSinceRefresh;
                
                // Set timeout for the remaining time
                setTimeout(() => {
                    localStorage.setItem('lastRefreshTime', Date.now().toString());
                    window.location.reload(true);
                }, timeUntilRefresh);
            }
            
            // Also set a recurring 12-hour interval as a backup
            setInterval(() => {
                localStorage.setItem('lastRefreshTime', Date.now().toString());
                window.location.reload(true);
            }, twelveHours);
        }
        
        // Setup auto-refresh
        setupAutoRefresh();
        
        // Start loading missions when page loads
        loadMissions();
    </script>
</body>

</html>